<!--
 * SPDX-FileCopyrightText: Copyright (c) 2023-present NVIDIA CORPORATION & AFFILIATES.
 * All rights reserved.
 * SPDX-License-Identifier: BSD-3-Clause
-->
# nvFuser Environment Configuration Tool

Interactive tool for managing nvFuser's 49 build and runtime environment variables.

## Quick Setup (Auto-install)

From Fuser/main directory, copy-paste ONE command:

```bash
# For bash
echo 'eval "$('$PWD'/tools/env-config/nvfuser-config-shell.sh)"' >> ~/.bashrc && source ~/.bashrc

# For zsh
echo 'eval "$('$PWD'/tools/env-config/nvfuser-config-shell.sh)"' >> ~/.zshrc && source ~/.zshrc
```

This appends the setup line to your RC file and immediately activates it.

**Verify:** `type nvfuser-configure` should show the function definition.

**Note:** Running this multiple times will add duplicate lines. If you need to remove duplicates later, edit your RC file manually.

## Manual Setup (if preferred)

Add this ONE LINE to your `~/.bashrc` (bash) or `~/.zshrc` (zsh):

```bash
eval "$($PWD/tools/env-config/nvfuser-config-shell.sh)"
```

Then reload your shell:
```bash
# For bash
source ~/.bashrc

# For zsh
source ~/.zshrc
```

**Note:** The script works with bash, zsh, and other POSIX-compatible shells.

## Usage

```bash
nvfuser-configure
```

**Apply Workflow (Immediate):**
1. Navigate (↑↓), Toggle (Enter), Edit (e) to configure variables
2. Press **a** to apply
3. Confirm with **y**
4. TUI exits, configuration is immediately active in your shell

**Generate Workflow (Reusable Script):**
1. Navigate (↑↓), Toggle (Enter), Edit (e) to configure variables
2. Press **g** to generate
3. Enter filename (default: nvfuser_env.sh)
4. TUI exits with script saved
5. Apply anytime: `source nvfuser_env.sh`

## What It Manages

**Build-time** (NVFUSER_BUILD_*, MAX_JOBS):
- Build type (Release/Debug), enable/disable components (python, cutlass, tests, benchmarks)
- Compiler flags, directories, parallelism

**Environment** (CC, CXX, CUDA_HOME, etc.):
- C/C++ compiler selection, CUDA paths, target architectures, compiler/linker flags

**Runtime** (NVFUSER_DUMP, NVFUSER_ENABLE/DISABLE):
- Debug output (fusion_ir, cuda_kernel, ptx, sass, scheduler info)
- Features (fast_math, cutlass_scheduler, tma kernels)
- Profiler modes

## Key Features

- ✅ Green highlighting for configured values
- ✅ Smart quit prompt (never lose changes)
- ✅ Auto-detection of current environment
- ✅ **Apply** immediately updates environment and exits
- ✅ **Generate** creates reusable scripts with proper unset logic
- ✅ Generated scripts clean up unconfigured variables for reproducibility

## Quick Examples

```bash
# Example 1: Debug build (Apply immediately)
nvfuser-configure
# Set: build_type=Debug, fusion_ir=on, cuda_kernel=on
# Press a→y
# Ready to build with debug configuration!

# Example 2: Custom compiler (Generate reusable script)
nvfuser-configure
# Set: cc=gcc-13, cxx=g++-13, cuda_home=/usr/local/cuda-12.6
# Press g
# Enter: my_compiler_config.sh
source my_compiler_config.sh
# Use this script anytime you want this configuration

# Example 3: Inspect current configuration
env | grep -E '^(NVFUSER_|MAX_JOBS|CC|CXX|CUDA_HOME)' | sort

# Example 4: Clear specific variables manually
unset NVFUSER_DUMP NVFUSER_ENABLE
```

## Alternative (without shell setup)

```bash
python tools/env-config/configure_env.py              # TUI mode
python tools/env-config/configure_env.py --simple     # Prompt mode
# Note: Without shell function setup, you'll need to manually source generated scripts
# After pressing 'a': source .nvfuser_apply.*.sh  (generated with random suffix)
# After pressing 'g': source nvfuser_env.sh
```

## Understanding Generated Scripts

Generated scripts include both:
- **unset** commands for unconfigured variables (ensures clean slate)
- **export** commands for configured variables

Example generated script:
```bash
#!/bin/bash
# nvFuser Environment Configuration
# Generated by tools/configure_env.py

# Unset unconfigured variables
unset NVFUSER_BUILD_BUILD_TYPE
unset NVFUSER_DISABLE
unset NVFUSER_DUMP

# Export configured variables
export CUDA_HOME="/usr/local/cuda-12.6"
export MAX_JOBS="16"
export NVFUSER_ENABLE="fast_math,kernel_profile"
```

This ensures reproducibility - sourcing the script multiple times gives identical results.

## See Also

- Variable reference: `../../CLAUDE.md` (Runtime Configuration section)
- Quick reference: `ENV_QUICK_REFERENCE.txt`
- Main tools README: `../README.md`
